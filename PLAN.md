# Kiro v2.0 Renderer 개발 계획

본 문서는 Kiro v2.0 명세에 기반한 Python 렌더러의 구체적인 개발 계획을 정의합니다.

## 1. 핵심 아키텍처: 2-Pass 파싱 및 AST 기반 렌더링

무분별한 정규식 사용은 복잡하고 유지보수가 어려운 코드를 만듭니다. 따라서, 다음과 같은 체계적인 접근 방식을 채택합니다.

1.  **1st Pass (블록 파싱)**: 먼저 문서 전체를 순회하며 문단을 구성하는 **블록(Block) 단위** 요소(헤딩, 리스트, 코드 블록, 인용 등)를 식별합니다.
2.  **AST (Abstract Syntax Tree) 생성**: 파싱된 블록들을 트리 형태의 자료구조(AST)로 변환합니다. 각 노드는 요소의 타입과 내용을 가집니다.
3.  **2nd Pass (인라인 파싱)**: 생성된 AST의 각 노드를 순회하며, 블록 내부에 있는 **인라인(Inline) 요소**(굵게, 기울임, 스타일 스팬 등)를 파싱하여 노드를 더욱 풍부하게 합니다.
4.  **HTML 렌더링**: 최종적으로 완성된 AST를 순회(Visitor 패턴 사용)하며 각 노드에 맞는 HTML 태그를 생성하여 최종 결과물을 조립합니다.

이 방식은 구조와 내용을 분리하여 복잡성을 제어하고, 향후 기능 확장을 용이하게 합니다.

## 2. 데이터 구조 (AST 노드)

`src/kiro_renderer/nodes.py` (신규 생성) 파일에 다음과 같은 데이터 클래스를 정의합니다.

```python
# 예시
from dataclasses import dataclass
from typing import List

@dataclass
class Node: ...

@dataclass
class TextNode(Node):
    content: str

@dataclass
class BoldNode(Node):
    content: List[Node] # 다른 인라인 노드를 중첩 가능

@dataclass
class ParagraphNode(Node):
    content: List[Node]

@dataclass
class HeadingNode(Node):
    level: int
    content: List[Node]

# ... 기타 모든 Kiro 요소를 위한 노드 추가 ...
```

## 3. 구현 단계별 계획

### Phase 1: 기반 구축 및 기본 블록 파서 구현

-   **목표**: 가장 단순한 블록 요소들을 처리하는 파서의 뼈대를 완성합니다.
-   **작업 내용**:
    1.  `src/kiro_renderer/nodes.py` 파일 및 기본 노드 클래스 생성.
    2.  `core.py`에 `render` 함수와 기본 파서 클래스(`KiroParser`) 구조 잡기.
    3.  **파싱 대상**:
        -   헤딩 (`# ...`)
        -   구분선 (`---`)
        -   일반 문단 (다른 블록에 해당하지 않는 텍스트)

### Phase 2: 여러 줄에 걸친 블록 파서 구현

-   **목표**: 여러 줄을 차지하는 복잡한 블록들을 처리합니다.
-   **작업 내용**:
    1.  **코드 블록** (``````...``````): 시작과 끝이 명확하여 파싱하기 용이합니다. `Pygments`를 이용한 구문 강조 기능을 여기에 통합합니다.
    2.  **인용 블록** (`| ...`): 연속된 `|` 라인을 하나의 인용 블록으로 묶습니다.
    3.  **리스트 블록** (`-`, `*`, `-1.A.`): 가장 복잡한 부분입니다.
        -   리스트의 시작과 끝을 감지하는 로직 구현.
        -   들여쓰기를 통해 중첩 리스트를 파싱하는 기능 구현.
        -   "보고서형"과 "표준" 리스트를 구분하는 로직 구현.

### Phase 3: 인라인 파서 구현

-   **목표**: 블록 노드 내의 텍스트를 파싱하여 인라인 요소를 처리합니다.
-   **작업 내용**:
    1.  `parse_inlines(text: str) -> List[Node]` 함수 구현.
    2.  **파싱 대상**:
        -   이스케이프 문자 (`\`) 처리 (가장 먼저 처리해야 함)
        -   굵게 (`**...**`), 기울임 (`*...*`), 취소선 (`~~...~~`)
        -   인라인 코드 (`` `...` ``)
        -   각주 참조 (`[^id]`)

### Phase 4: Kiro 전용 고급 기능 구현

-   **목표**: Kiro의 독자적인 고급 기능들을 구현합니다.
-   **작업 내용**:
    1.  **`<style>` 블록 파싱**: CSS 규칙을 파싱하여 내부 스타일 사전에 저장합니다. 이 블록은 HTML로 렌더링되지 않습니다.
    2.  **스타일 스팬 적용** (`[style]...<>`): 인라인 파싱 단계에서 스타일 사전을 참조하여 `<span>` 태그와 CSS 클래스를 적용합니다.
    3.  **외부 리소스** (`@img`, `@link` 등) 파싱.
    4.  **각주 내용** (`[^id]: ...`) 파싱 및 각주 참조와의 연결.
    5.  **토글** (`> ...`) 및 **매크로** (`!youtube(...)`) 기능 구현.

### Phase 5: 테스트, CLI 연동 및 배포 준비

-   **목표**: 구현된 기능의 안정성을 확보하고 사용자가 쉽게 쓸 수 있도록 만듭니다.
-   **작업 내용**:
    1.  **단위 테스트 작성 (`tests/`)**: `pytest`를 사용하여 각 기능별 테스트 케이스를 작성합니다. 특히 엣지 케이스(중첩, 빈 내용, 오류 등)를 집중적으로 테스트합니다.
    2.  **CLI (`cli.py`) 개선**: 파서와 완전히 연동하고, 오류 메시지를 친절하게 출력하도록 개선합니다.
    3.  **문서화**: `README.md`를 최종 업데이트하고, 코드 내에 Docstring을 충실히 작성합니다.
    4.  **PyPI 배포 준비**: `pyproject.toml`을 최종 검토하고, 패키지 빌드 및 배포 절차를 확인합니다.

## 4. 파일 구조 변경 제안

-   `src/kiro_renderer/core.py` -> `src/kiro_renderer/parser.py` (파서의 역할 명확화)
-   `src/kiro_renderer/renderer.py` (신규): AST를 HTML로 변환하는 로직 분리
-   `src/kiro_renderer/nodes.py` (신규): AST 노드 클래스 정의

이 계획에 따라 체계적으로 개발을 진행할 것을 제안합니다.
